#!/bin/sh

STATUS_FILE=/var/run/status_file
KERNEL=$(uci get node.general.kernel)
BOARD=$(uci get node.general.board)
cp_HANDLER=$(uci get cp_switch.main.which_handler)
RR=$(uci get flags.status.RR)
IP=$(uci get node.general.IP_mesh)

robin_version=$(cat /etc/robin_version)

# Percent-encoding special chars for URLs, via simple lookup table
percent_encode() {
	echo $1 | sed -e 's|%|%25|g' \
		-e 's|!|%21|g' \
		-e 's|#|%23|g' \
		-e 's|\$|%24|g' \
		-e 's|&|%26|g' \
		-e "s|'|%27|g" \
		-e 's|(|%28|g' \
		-e 's|)|%29|g' \
		-e 's|*|%2A|g' \
		-e 's|+|%2B|g' \
		-e 's|,|%2C|g' \
		-e 's|/|%2F|g' \
		-e 's|:|%3A|g' \
		-e 's|;|%3B|g' \
		-e 's|=|%3D|g' \
		-e 's|?|%3F|g' \
		-e 's|@|%40|g' \
		-e 's|\[|%5B|g' \
		-e 's|]|%5D|g' \
		-e 's| |%20|g'
}


echo "get node status..."
rm -f $STATUS_FILE

case $BOARD in
	"bullet-m"|"nanostation-m"|"rocket-m") MAC_TO_SEND=$(uci get node.general.wlanMAC) ;;
	*) MAC_TO_SEND=$(uci get node.general.myMAC) ;;
esac

robin_version="${robin_version}-${KERNEL}"

cp_name=$(uci get cp_switch."handler_${cp_HANDLER}".cp_name)

ra_signature="O"
RA_VER=$(cat /etc/olsr_version)

ROBIN_VER="${robin_version}/${cp_name}${ra_signature}"

PSSID="-none-"
# CONFIGCHANGE
#case $(uci get node.general.ethPorts) in
#	2) 	SSID=$(uci get wireless.@wifi-iface[1].ssid) 
#		[ "$(uci get mesh.Myap.up)" -eq 1 ] && PSSID=$(uci get wireless.@wifi-iface[2].ssid)
#		;;
#	1) 	SSID=$(uci get wireless.public.ssid) 
#		[ "$(uci get mesh.Myap.up)" -eq 1 ] && PSSID=$(uci get wireless.private.ssid)
#		;;
#esac
SSID=$(uci get wireless.@wifi-iface[1].ssid)
[ "$(uci get mesh.Myap.up)" -eq 1 ] && PSSID=$(uci get wireless.@wifi-iface[2].ssid)

# Need to percent-encode the SSIDs for whitespace chars
SSID=$(percent_encode "$SSID")
PSSID=$(percent_encode "$PSSID")

[ 1 -eq "$RR" ] && {
	uci set flags.status.RR="0"
	uci commit flags
}

echo -n "ip=${IP}&mac=${MAC_TO_SEND}&robin=${ROBIN_VER}&batman=${RA_VER}" > $STATUS_FILE
echo -n "&ssid=${SSID}&pssid=${PSSID}&RR=${RR}">> $STATUS_FILE
#
