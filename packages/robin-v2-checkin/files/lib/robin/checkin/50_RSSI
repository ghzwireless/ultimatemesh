#!/bin/sh

STATUS_FILE=/var/run/status_file
CONVERT_TO_RSSI=' { printf( "%2.0f\n", ((95 - $0)/0.6)) } '

STATION_IP=
NEIG=""
RSSI=""

iw dev $(uci -P /var/state get network.mesh.ifname) station dump > /tmp/station_dump

while read record ; do
	case $(echo $record |awk '{print $1}') in
		'Station') 
			STATION_MAC=$(echo $record |awk '{print $2}') 
			STATION_IP=$(grep -i $STATION_MAC /etc/update/network_nodes |awk '{print $2}')
			# If multiple VIFs, MAC reported in station dump may be hardware MAC
			# with 2, 4, 6, etc, added to 1st octet
			[ -z "$STATION_IP" ] && {
				OCTET=$(echo $STATION_MAC | cut -d ":" -f1)
				OCTET=$(printf "%d" 0x${OCTET})
				OCTET=$(printf "%02x" $(( $OCTET - 2 )))
				REST=$(echo $STATION_MAC | cut -d ":" -f2-6)
				STATION_MAC="${OCTET}:${REST}"
				STATION_IP=$(grep -i $STATION_MAC /etc/update/network_nodes |awk '{print $2}')
			}
			[ -z "$STATION_IP" ] && {
                                OCTET=$(echo $STATION_MAC | cut -d ":" -f1)
                                OCTET=$(printf "%d" 0x${OCTET})
                                OCTET=$(printf "%02x" $(( $OCTET - 2 )))
                                REST=$(echo $STATION_MAC | cut -d ":" -f2-6)
                                STATION_MAC="${OCTET}:${REST}"
                                STATION_IP=$(grep -i $STATION_MAC /etc/update/network_nodes |awk '{print $2}')
                        }
                        [ -z "$STATION_IP" ] && {
                                OCTET=$(echo $STATION_MAC | cut -d ":" -f1)
                                OCTET=$(printf "%d" 0x${OCTET})
                                OCTET=$(printf "%02x" $(( $OCTET - 2 )))
                                REST=$(echo $STATION_MAC | cut -d ":" -f2-6)
                                STATION_MAC="${OCTET}:${REST}"
                                STATION_IP=$(grep -i $STATION_MAC /etc/update/network_nodes |awk '{print $2}')
                        }
                        ;;
				
		'signal:') 
			[ -n "$STATION_IP" ] && {
				STATION_dBm=$(echo $record |awk '{print $2}' |sed s/'-'//g) 
  				conv=$(echo $STATION_dBm | awk "$CONVERT_TO_RSSI" | tr -d " ")
				NEIG="${NEIG}$STATION_IP;"
				RSSI="${RSSI}$conv;"
			}
			;;
	esac
done < /tmp/station_dump

NEIG="${NEIG}z" && NEIG_=$(echo $NEIG |sed "s/;z//g")
RSSI="${RSSI}z" && RSSI_=$(echo $RSSI |sed "s/;z//g")	
echo -n "&nodes=${NEIG_}&rssi=${RSSI_}" >> $STATUS_FILE
#
